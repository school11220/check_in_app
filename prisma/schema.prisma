datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

generator client {
  provider = "prisma-client-js"
}



enum Role {
  ADMIN
  ORGANIZER
  SCANNER
  USER
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  password         String
  name             String?
  role             Role     @default(USER)
  assignedEventIds String[] @default([]) // For Organizers/Scanners to restrict access

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PricingRule {
  id              String   @id @default(uuid())
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  triggerType     String   // TIME_BASED (hours before), DEMAND_BASED (% sold)
  triggerValue    Int      // e.g. 24 (hours) or 80 (%)
  
  adjustmentType  String   // PERCENTAGE, FIXED
  adjustmentValue Int      // e.g. 10 (%) or 500 (rupees)
  
  active          Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([eventId])
  @@index([active])
}

model Event {
  id          String   @id @default(uuid())
  name        String
  description String?
  date        DateTime // We will store this as the date object
  startTime   String   @default("09:00")
  endTime     String   @default("18:00")
  venue       String?
  address     String?
  price       Int      @default(0) // in paise
  entryFee    Int      @default(0)
  prizePool   Int      @default(0)
  category    String   @default("other")
  imageUrl    String?
  capacity    Int      @default(100)
  soldCount   Int      @default(0)
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  
  // JSON fields for complex data
  schedule    Json     @default("[]")
  speakers    Json     @default("[]")
  sponsors    Json     @default("[]")
  tags        String[] @default([])
  
  organizer   String?
  contactEmail String?
  contactPhone String?
  termsAndConditions String?
  
  registrationDeadline String?
  earlyBirdEnabled Boolean @default(false)
  earlyBirdPrice   Int     @default(0)
  earlyBirdDeadline String?
  sendReminders    Boolean @default(false)
  
  // Custom Registration Questions
  registrationFields Json @default("[]") // Stores [{ id, label, type, required, options }]
  
  // Virtual Meeting Integration
  videoLink          String?   // For participants
  organizerVideoLink String?   // For organizers


  tickets     Ticket[]

  // photos      Photo[] // Removed in favor of gallery JSON
  gallery     Json     @default("[]") // Stores { imageUrl, uploaderName, caption, approved, likes }[]
  reviews     Review[]
  pricingRules PricingRule[]
  sessions    Session[] // TimeSlots merged into sessions or removed

  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([category])
}


model Ticket {
  id              String    @id @default(uuid())
  name            String
  email           String?
  phone           String?
  eventId         String
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  status          String    @default("pending")
  token           String?
  razorpayOrderId String?
  razorpayPaymentId String?
  checkedIn       Boolean   @default(false)
  checkedInAt     DateTime?
  
  // Multi-ticket support
  purchaseGroupId String?   // To group tickets bought together
  
  // Custom Registration Answers
  customAnswers   Json      @default("{}") // Stores { "questionId": "answer" }

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([eventId])
  @@index([status])
  @@index([email])
  @@index([razorpayOrderId])
}





model Review {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userName  String
  rating    Int
  comment   String
  
  createdAt DateTime @default(now())
  
  @@index([eventId])
}





model Session {
  id          String   @id @default(uuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  type        String   @default("talk")
  
  speakerName String?
  speakerRole String?
  
  startTime   String   // "09:00"
  endTime     String   // "10:00"
  date        String   // "2024-12-25"
  
  capacity    Int      @default(100)
  registeredCount Int  @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventId])

}

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE, LOGIN, CHECKIN
  resource    String   // Event, Ticket, User, Settings
  resourceId  String?
  details     Json?    // { changes: ..., snapshot: ... }
  
  userId      String
  userName    String   // Snapshot of user name
  userRole    String   // Snapshot of role
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

model Integration {
  id          String   @id @default(uuid())
  provider    String   // zoom, google_meet, slack
  name        String   // Display name
  type        String   // meeting, messaging, analytics
  
  isEnabled   Boolean  @default(false)
  config      Json     @default("{}") // { apiKey: "", webhookUrl: "" }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([provider])
}

model SiteConfig {
  id        String   @id @default("default")
  settings  Json     @default("{}") // Stores SiteSettings including customPages
  templates Json     @default("[]") // Stores EmailTemplates
  surveys   Json     @default("[]") // Stores Surveys
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



